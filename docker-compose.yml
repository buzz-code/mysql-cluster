version: "3.8"

services:
  # -------------------------------------------------------
  # 1. The Database Server (Dedicated Node)
  # -------------------------------------------------------
  db:
    image: mysql:8.0
    hostname: mysql-primary
    environment:
      MYSQL_ROOT_PASSWORD: "${DB_PASSWORD}"
      TZ: "Asia/Jerusalem"
    
    configs:
      - source: mysql_custom_config
        target: /etc/mysql/my.cnf
    
    volumes:
      - mysql_data:/var/lib/mysql
    
    networks:
      - backend-network

    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${DB_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.labels.role == database
      resources:
        limits:
          cpus: '3.5'
          memory: 7G
        reservations:
          cpus: '2'
          memory: 7G
      restart_policy:
        condition: on-failure

  # -------------------------------------------------------
  # 2. PhpMyAdmin (Runs anywhere BUT the DB node)
  # -------------------------------------------------------
  phpmyadmin:
    image: phpmyadmin:5.2.1
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.labels.role != database
      # labels:
      #   caddy: db-admin.$DOMAIN_NAME
      #   caddy.reverse_proxy: "{{upstreams 80}}"
    environment:
      PMA_HOST: db 
      UPLOAD_LIMIT: 100M
    networks:
      - backend-network

  # -------------------------------------------------------
  # 3. Automated Backups (Runs anywhere)
  # -------------------------------------------------------
  backup:
    image: tiredofit/db-backup
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.labels.role != database
    volumes:
      - backup_cache:/backup
    networks:
      - backend-network
    environment:
      - TZ=Asia/Jerusalem
      - CONTAINER_ENABLE_MONITORING=FALSE
      
      - DEFAULT_BACKUP_BEGIN=0 3 * * *
      - DEFAULT_CLEANUP_TIME=10080
      - DEFAULT_COMPRESSION=ZSTD
      - DEFAULT_CHECKSUM=MD5
      - DEBUG_MODE: TRUE

      # --- Job 1: MySQL Database ---
      - DB01_TYPE=mysql
      - DB01_HOST=db
      - DB01_USER=root
      - DB01_PASS=${DB_PASSWORD}
      - DB01_NAME=ALL
      - DB01_LOG_LEVEL=DEBUG

      # --- S3 / Cloud Storage Settings (Optional) ---
      # כדי להפעיל, יש להסיר את ההערות (#) ולהגדיר את המשתנים
      
      # - DEFAULT_BACKUP_LOCATION=S3      # שינוי מ-FILESYSTEM ל-S3
      
      # הגדרות S3 (מתאים ל-AWS, Wasabi, Backblaze B2, MinIO)
      # - DEFAULT_S3_BUCKET=my-bucket-name
      # - DEFAULT_S3_REGION=us-east-1     # או ה-Region של הספק שלך
      # - DEFAULT_S3_HOST=s3.us-west-000.backblazeb2.com # דוגמה ל-Backblaze
      # - DEFAULT_S3_KEY_ID=xxxxxxxx      # המפתח הציבורי
      # - DEFAULT_S3_KEY_SECRET=xxxxxxxx  # המפתח הפרטי
      # - DEFAULT_S3_PATH=mysql_backups   # תיקייה בתוך הבאקט

volumes:
  mysql_data:
    driver: local
  backup_cache:
    driver: local

networks:
  backend-network:
    external: true

configs:
  mysql_custom_config:
    file: ./config/my.cnf
