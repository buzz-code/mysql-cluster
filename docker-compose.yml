version: "3.8"

services:
  # -------------------------------------------------------
  # 1. The Database Server (Dedicated Node)
  # -------------------------------------------------------
  db:
    image: mysql:8.0
    hostname: mysql-primary
    environment:
      MYSQL_ROOT_PASSWORD: "${DB_PASSWORD}"
      TZ: "Asia/Jerusalem"
    
    configs:
      - source: mysql_custom_config
        target: /etc/mysql/my.cnf
    
    volumes:
      - mysql_data:/var/lib/mysql
    
    networks:
      - backend-network

    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${DB_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.labels.role == database
      resources:
        limits:
          cpus: '3.5'
          memory: 7G
        reservations:
          cpus: '2'
          memory: 7G
      restart_policy:
        condition: on-failure

  # -------------------------------------------------------
  # 2. PhpMyAdmin (Runs anywhere BUT the DB node)
  # -------------------------------------------------------
  phpmyadmin:
    image: phpmyadmin:5.2.1
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.labels.role != database
      # labels:
      #   caddy: db-admin.$DOMAIN_NAME
      #   caddy.reverse_proxy: "{{upstreams 80}}"
    environment:
      PMA_HOST: db 
      UPLOAD_LIMIT: 100M
    networks:
      - backend-network

  # -------------------------------------------------------
  # 3. Automated Backups (Runs anywhere)
  # -------------------------------------------------------
  backup:
    image: tiredofit/db-backup
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.labels.role != database
    volumes:
      - backup_cache:/backup
    networks:
      - backend-network
    environment:
      - TZ=Asia/Jerusalem
      - CONTAINER_ENABLE_MONITORING=FALSE
      
      - DEFAULT_BACKUP_BEGIN=0 3 * * *
      - DEFAULT_CLEANUP_TIME=10080
      - DEFAULT_COMPRESSION=ZSTD
      - DEFAULT_CHECKSUM=MD5
      - DEBUG_MODE=${DEBUG_MODE}

      # --- S3 / Cloud Storage Settings ---
      - DEFAULT_BACKUP_LOCATION=S3
      - DEFAULT_BACKUP_TYPE=S3
      - DEFAULT_S3_BUCKET=${S3_BUCKET}
      - DEFAULT_S3_HOST=${S3_HOST}
      - DEFAULT_S3_REGION=${S3_REGION}
      - DEFAULT_S3_KEY_ID=${S3_KEY_ID}
      - DEFAULT_S3_KEY_SECRET=${S3_KEY_SECRET}
      - DEFAULT_S3_PATH=mysql_backups
      - DEFAULT_S3_URI_STYLE=Path

      # --- Job 1: MySQL Database ---
      - DB01_TYPE=mysql
      - DB01_HOST=db
      - DB01_USER=root
      - DB01_PASS=${DB_PASSWORD}
      - DB01_NAME=ALL
      - DB01_LOG_LEVEL=DEBUG

volumes:
  mysql_data:
    driver: local
  backup_cache:
    driver: local

networks:
  backend-network:
    external: true

configs:
  mysql_custom_config:
    file: ./config/my.cnf
